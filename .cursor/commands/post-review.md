# Post Review Command

Post code review findings to a GitHub Pull Request as inline comments and additional review comments.

---

The user input to you can be provided directly by the agent or as a command argument - you **MUST** consider it before proceeding with the prompt (if not empty).

User input:

$ARGUMENTS

## Goal

Read a review file generated by `/review` command and post findings to a GitHub PR:

- Findings with specific `file:line` references â†’ post as inline comments at those lines
- Findings without specific line references â†’ combine into review body as "Additional Findings"
- Tag the PR author in all comments

## Execution Steps

1. **Parse Arguments**:
   - Extract PR number from `$ARGUMENTS` (format: `--pr <number>` or `--pr-number <number>`)
   - Extract review file path (format: `--review <path>` or default to `reviews/REVIEW_<branch>.md` based on PR branch)
   - Extract repository owner/repo if different from default (format: `--repo <owner/repo>`)
   - **Required**: PR number must be provided; fail if missing

2. **Load Review File**:
   - If `--review` path provided, use that exact path
   - Otherwise, look for `REVIEW_*.md` files under `reviews/` matching PR branch name
   - **Hard error**: If review file not found and `--review` was not provided, fail with error message asking user to specify path
   - Parse the review structure:
     - Review Summary (decision, risk, summary, baseline)
     - Key Recommendations (may have file:line format but are NOT findings - include in review body only)
     - Findings (grouped by severity: Critical, High, Medium, Low) - these are the items to post as comments
     - Metrics Summary
     - Strengths
     - Questions for Author
   - **Note**: "Key Recommendations" section may contain file:line references but these are NOT findings - they go in the review body, not as inline comments

3. **Get PR Information**:
   - Use `mcp_github_pull_request_read(method="get")` to get PR details:
     - PR number from arguments
     - PR author username (for tagging)
     - PR branch name
   - Use `mcp_github_pull_request_read(method="get_files")` to get list of changed files
   - **Required**: PR must exist; fail if PR not found

4. **Parse Findings**:
   - Extract all findings from the "Findings" section (only items under "### Critical", "### High", "### Medium", "### Low" subsections)
   - Skip lines that say "None." or are empty
   - **Check for zero findings**: If all severity sections contain only "None." or are empty, and Metrics Summary shows "Total Findings | 0", then this is a zero-findings review
   - Parse format: `[ID][Severity][Tag] file:line â€“ Description. **Change:** Recommendation. **Validate:** How to test.`
   - Use the following approach (supports wrapped Change/Validate on indented lines):

     **Primary regex for bullet line**:
     ```
     ^-\s*\[([^\]]+)\]\[([^\]]+)\]\[([^\]]+)\]\s+([^:`]+):(\d+)\s*â€“\s*(.+)$
     ```

     **Subsequent line parsing** (after matching bullet line):
     - Read following lines and collect indented lines (2+ spaces)
     - Extract `**Change:**` value if present
     - Extract `**Validate:**` value if present
     - Stop when reaching the next finding or a different section

     Groups:
     1. Finding ID (e.g., `Spec-1`)
     2. Severity (e.g., `High`)
     3. Tag (e.g., `Spec`)
     4. File path
     5. Line number (refers to the target branch file, not the diff)
     6. Description

   - Also handle multi-line format where "Change:" appears on the next line (check if the next non-empty line starts with "Change:" or "**Change:**")
   - Normalize file paths:
     - Strip repo-root prefixes: `src/file.py` â†’ `src/file.py` (keep relative to repo root)
     - Strip diff prefixes (`a/`, `b/`) if present
     - Handle Windows drive letters safely: `C:\path\to\file.py` â†’ `path/to/file.py`
     - **Note**: File paths in review files are typically repo-relative (e.g., `src/...`), match against PR files list which also uses repo-relative paths

5. **Get and Parse PR Diff**:
   - Call `mcp_github_pull_request_read(method="get_diff")` **once** to get the full diff
   - Parse diff and walk lines to build exact line mapping:
     - For each file in diff:
       - Extract file path from diff header: `diff --git a/path/to/file b/path/to/file` â†’ normalize to `path/to/file`
       - Parse hunk headers: `@@ -old_start,old_count +new_start,new_count @@`
       - Track current line counters:
         - `old_line = old_start` (for deleted lines, LEFT side)
         - `new_line = new_start` (for added lines, RIGHT side)
       - Walk through each line in the diff:
         - Lines starting with `+` (added): Map `new_line` â†’ `{side: "RIGHT", line: new_line, file_line: new_line}`, increment `new_line`
         - Lines starting with `-` (deleted): Map `old_line` â†’ `{side: "LEFT", line: old_line, file_line: old_line}`, increment `old_line`
         - Lines starting with ` ` (space, context): Increment both `old_line` and `new_line` but **do not map** (context lines are not commentable)
         - Lines starting with `\` (backslash, no newline): Skip (no-op lines)
       - Store mapping: `{file_path: {target_file_line_number: {side: "RIGHT"|"LEFT", diff_line: <number>}}}`
       - **Important**: The mapping stores target file line numbers (what's in the review file) â†’ diff line numbers (what the GitHub API needs)
     - **Critical**: Only map lines that start with `+` or `-`; ignore context lines (starting with space)
     - **Note**: Review file line numbers refer to the target branch file. Map these to the corresponding diff lines (RIGHT for additions, LEFT for deletions)

6. **Validate and Map Findings to PR Diff**:
   - For each finding with `file:line`:
     - Normalize file path (strip repo prefixes, diff prefixes, Windows drives)
     - **Match file path**: Compare normalized path against PR files list from `get_files` (which returns repo-relative paths)
     - If file not in PR: categorize as general finding (fallback)
     - If file exists: look up the line number from review file in parsed diff line mapping
     - **Line number mapping logic**:
       - Review file line numbers refer to the **target branch file** (the new file after changes)
       - Look up in mapping: `mapping[file_path][review_line_number]`
       - If found â†’ use `side` and `diff_line` from mapping
       - If not found â†’ check if it's a context line (between hunks) or outside diff range â†’ categorize as general finding
     - **Important**: The review file line number (e.g., 205) refers to the final file state, so look it up in the RIGHT side mapping (new file lines)
     - **Do not** try "nearest line" fallback; if the line doesn't exist in the mapping, move to general comments

7. **Categorize Findings**:
   - **Line-specific**: Has `file:line` AND file exists in PR AND line exists in diff hunks
   - **General**: No `file:line` OR file not in PR OR line not in diff hunks

8. **Create Pending Review**:
   - **If zero findings**: Skip this step (will create review directly with approval in step 10)
   - **Otherwise**: Use `mcp_github_pull_request_review_write(method="create")` to create pending review
   - **Use empty body** (`body: ""`) - review body will be set when submitting
   - This keeps a single source of truth for the review body

9. **Post Inline Comments** (for line-specific findings):
   - **If zero findings**: Skip this step (no comments to post)
   - For each validated line-specific finding:
     - Extract: file path (normalized), line number (from mapping), finding ID, severity, tag, description, change recommendation, validation instruction
     - **Clean up description**: Description is everything before `**Change:**` separator
     - **Format comment body**:

       ```
       @<author> **[ID][Severity][Tag]**: Description.

       **Change:** Recommendation.
       **Validate:** How to test.
       ```

     - Use `mcp_github_add_comment_to_pending_review` with:
       - `subjectType: "LINE"` (uppercase, required)
       - `side: "RIGHT"` or `side: "LEFT"` (from diff mapping - typically "RIGHT" for new/modified code)
       - `line: <diff_line>` (the actual diff line number from mapping, not the review file line number)
       - `path: <normalized_file_path>` (repo-relative path matching PR files list)
       - `body: <formatted_comment>`
       - **Note**: The MCP API uses `line` (diff line number) and `side` only (no position/startLine/endLine needed)
     - Tag author once at the top of comment body (not in every bullet)
     - **Error handling**: If comment posting fails, log the error but continue with other findings

10. **Build Review Body and Submit Review**:
    - **Check for zero findings**: If Total Findings = 0 (all severity sections show "None." or are empty):
      - Look for "Review Completion Message" section in review file
      - If found, use that message as the review body (replace `@<author>` placeholder with actual author username)
      - If not found, use default: `Congratulations @<author>, you are good to go! ðŸ”¥ðŸš€`
      - Set `event: "APPROVE"` (no findings = automatic approval)
      - Skip inline comments (no findings to comment on)
    - **Otherwise** (if findings exist), build complete review body with:
      - `@<author>` tag at top (once, not in every section)
      - Review Summary section (from review file)
      - Key Recommendations section (from review file)
      - Additional Findings section (only if there are general findings):

        ```
        ## Additional Findings (not tied to specific lines)

        ### Critical
        - **[ID][Severity][Tag]**: Description.
          **Change:** Recommendation.
          **Validate:** How to test.

        ### High
        ...
        ```

      - Include all general findings grouped by severity (omit entire section if zero general findings)
    - Determine review event based on findings:
      - **If zero findings** â†’ `event: "APPROVE"` (automatic approval)
      - If Critical or High severity findings exist â†’ `event: "REQUEST_CHANGES"` (override `--approve` flag if present)
      - If only Medium/Low findings â†’ `event: "COMMENT"`
      - If user explicitly requests approval (`--approve` flag) AND no Critical/High findings â†’ `event: "APPROVE"`
      - **Safety**: Never approve if Critical/High findings exist, even with `--approve` flag
    - **If zero findings**:
      - Extract congratulatory message from "Review Completion Message" section in review file (replace `@<author>` placeholder with actual author username)
      - If "Review Completion Message" section not found, use default: `Congratulations @<author>, you are good to go! ðŸ”¥ðŸš€`
      - Use `mcp_github_pull_request_review_write(method="create")` directly with:
        - `body: <congratulatory_message>` (with author username substituted)
        - `event: "APPROVE"`
    - **Otherwise**: Use `mcp_github_pull_request_review_write(method="submit_pending")` with:
      - `body: <complete_review_body>` (built above)
      - `event: <determined_event>`
    - This is the single source of truth for the review body

11. **Output Summary**:
    - Display summary of posted comments:
      - Number of inline comments posted
      - Number of general findings included in review body
      - PR link
      - Review status (COMMENT/REQUEST_CHANGES/APPROVE)
    - **If zero findings**: Display the congratulatory message prominently in the output summary

## Finding Format Parsing

Parse findings using this approach:

**Primary regex for bullet line**:
```
^\-\s*\[([^\]]+)\]\[([^\]]+)\]\[([^\]]+)\]\s+([^:`]+):(\d+)\s*â€“\s*(.+)$
```

Groups:
1. Finding ID (e.g., `Spec-1`)
2. Severity (e.g., `High`)
3. Tag (e.g., `Spec`)
4. File path
5. Line number (refers to the target branch file, not the diff)
6. Description

**Subsequent line parsing** (after matching bullet line):
- Read following lines and collect indented lines (2+ spaces)
- Extract `**Change:**` value if present
- Extract `**Validate:**` value if present
- Stop when reaching the next finding or a different section

**Example finding with wrapped Change/Validate**:

```
- `[Spec-1][High][Spec] file.py:205 â€“ Description text.
  **Change:** Fix recommendation.
  **Validate:** Run pytest file.py -v
```

## File Path Normalization

Normalize file paths before matching against PR files:

- Strip diff prefixes: `a/src/file.py` â†’ `src/file.py`, `b/src/file.py` â†’ `src/file.py`
- Strip repo-root prefixes:
  - `/home/user/repo/src/file.py` â†’ `src/file.py`
  - Handle Windows drive letters safely: `C:\path\to\file.py` â†’ `path/to/file.py`
- Convert to repo-relative paths
- Match against PR files list from `get_files` API

## Comment Formatting

### Inline Comments

```markdown
@<author> **[ID][Severity][Tag]**: Description.

**Change:** Recommendation.
**Validate:** How to test.
```

### Review Body (General Findings)

```markdown
@<author>

## Review Summary
[Summary from review file]

## Key Recommendations
[Recommendations from review file]

## Additional Findings (not tied to specific lines)

### Critical
- **[ID][Severity][Tag]**: Description.
  **Change:** Recommendation.
  **Validate:** How to test.

### High
- **[ID][Severity][Tag]**: Description.
  **Change:** Recommendation.
  **Validate:** How to test.

### Medium
- **[ID][Severity][Tag]**: Description.
  **Change:** Recommendation.
  **Validate:** How to test.

### Low
- **[ID][Severity][Tag]**: Description.
  **Change:** Recommendation.
  **Validate:** How to test.
```

## Error Handling

- **PR not found**: Hard error with PR number and repository
- **Review file not found**: Hard error (unless `--review` was provided, then use that exact path)
- **File not in PR**: Move finding to general comments section
- **Line not in diff hunks**: Move finding to general comments section (no "nearest line" fallback)
- **GitHub API errors**: Retry once, then error message (don't promise exponential backoff)

## Behavior Rules

- **Always tag author**: Include `@<author>` once at the top of each inline comment and review body
- **Preserve finding IDs**: Keep the original finding ID format `[ID]` in comments
- **Group by severity**: Maintain severity grouping in general findings
- **Include recommendations**: Always include "Change:" recommendations when available
- **Include validation**: Always include "Validate:" instructions when available
- **Respect PR context**: Only post inline comments on files/lines that exist in PR diff (mapped lines only)
- **Review body structure**: Include Review Summary + Key Recommendations + Additional Findings (if any) in review body
- **SubjectType requirement**: Always use `subjectType: "LINE"` (uppercase) for inline comments
- **Side determination**:
  - Use `side: "RIGHT"` for new file line numbers (added/modified code, lines starting with `+`)
  - Use `side: "LEFT"` for old file line numbers (deleted code, lines starting with `-`)
  - Map by walking diff lines: only map `+` and `-` lines, ignore context lines (starting with space)
- **Inline comment API**: MCP uses `line` and `side` only (no position/startLine/endLine parameters needed)
- **Author tagging**: Tag author once at the top of review body and once at the top of each inline comment (not in every severity section)

## Review Event Determination

- **Critical or High findings** â†’ `REQUEST_CHANGES` (overrides `--approve` flag for safety)
- **Only Medium/Low findings** â†’ `COMMENT`
- **APPROVE** â†’ Only if user explicitly requests it (`--approve` flag) AND no Critical/High findings exist

## Example Usage

```bash
# Post review for PR 750
/post-review --pr 750

# Post review with custom review file
/post-review --pr 750 --review reviews/REVIEW_f-stream-transformer.md

# Post review for different repository
/post-review --pr 750 --repo GDP-ADMIN/ai-agent-platform

# Post review and approve (only if explicitly requested)
/post-review --pr 750 --approve
```

## Implementation Notes

- Use GitHub MCP tools:
  - `mcp_github_pull_request_read(method="get")` - Get PR details (author, branch)
  - `mcp_github_pull_request_read(method="get_files")` - Get changed files list (returns repo-relative paths)
  - `mcp_github_pull_request_read(method="get_diff")` - Get full diff (call once, parse hunks once)
  - `mcp_github_pull_request_review_write(method="create")` - Create pending review (empty body)
  - `mcp_github_add_comment_to_pending_review` - Add inline comments (subjectType: "LINE", side, line, path, body)
  - `mcp_github_pull_request_review_write(method="submit_pending")` - Submit review (full body, event)
- Parse review markdown using regex for findings (handle wrapped `**Change:**` and `**Validate:**` patterns on indented lines)
- Normalize file paths before matching (strip diff prefixes `a/`/`b/`, repo prefixes, Windows drives)
- **Critical**: Review file line numbers refer to the **target branch file** (final state), not the diff
- Parse diff once, walk lines to build exact line mapping:
  - Only map lines starting with `+` (added) â†’ `side="RIGHT"` with target file line number â†’ diff line number
  - Only map lines starting with `-` (deleted) â†’ `side="LEFT"` with source file line number â†’ diff line number
  - Ignore context lines (starting with space) - they are not commentable
  - Track line counters per hunk to map exact line numbers
  - **Mapping structure**: `{file_path: {target_file_line: {side: "RIGHT"|"LEFT", diff_line: <number>}}`
- Handle multi-line findings (description + change/validation on next line starting with "Change:" or "**Change:**")
- Preserve markdown formatting in comments
- Tag author once at top of review body and once at top of each inline comment (not in every severity section)
- Inline comments use `subjectType: "LINE"` and `side` + `line` (diff line number from mapping)
- Omit "Additional Findings" section entirely if there are zero general findings
- **Key insight**: Review file line numbers (e.g., 205) need to be mapped to diff line numbers (e.g., 260) using the parsed diff mapping

Context: $ARGUMENTS
